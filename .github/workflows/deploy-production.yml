name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.10.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.API_URL }}

      # æ‰“åŒ…æž„å»ºäº§ç‰©
      - name: Create deployment package
        run: |
          mkdir -p deploy
          cp -r .next deploy/
          cp -r public deploy/
          cp -r node_modules deploy/
          cp package.json deploy/
          cp package-lock.json deploy/
          cp next.config.js deploy/
          cd deploy && tar -czf ../deploy.frontend.tar.gz .
      # ä¸Šä¼ åˆ°æœåŠ¡å™¨
      - name: Deploy to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          source: "deploy.frontend.tar.gz"
          target: "/tmp"
          overwrite: true


      # åœ¨æœåŠ¡å™¨ä¸Šè§£åŽ‹å¹¶é‡å¯æœåŠ¡
      - name: Extract and restart service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # ðŸ”‘ å¤‡ä»½çŽ¯å¢ƒå˜é‡æ–‡ä»¶
            if [ -f /home/apps/storehouse/.env ]; then
              cp /home/apps/storehouse/.env /tmp/storehouse.env.backup
              echo "âœ… Backed up .env file"
            fi
            
            # å¤‡ä»½æ—§ç‰ˆæœ¬
            if [ -d /home/apps/storehouse ]; then
              mv /home/apps/storehouse /home/apps/storehouse.backup.$(date +%Y%m%d_%H%M%S)
            fi
            
            # è§£åŽ‹æ–°ç‰ˆæœ¬
            mkdir -p /home/apps/storehouse
            tar -xzf /tmp/deploy.frontend.tar.gz -C /home/apps/storehouse
            
            # ðŸ”‘ æ¢å¤çŽ¯å¢ƒå˜é‡æ–‡ä»¶
            if [ -f /tmp/storehouse.env.backup ]; then
              cp /tmp/storehouse.env.backup /home/apps/storehouse/.env
              rm /tmp/storehouse.env.backup
              echo "âœ… Restored .env file"
            else
              echo "âš ï¸ No .env backup found, creating default"
              cat > /home/apps/storehouse/.env << 'EOF'
            NODE_ENV=production
            HOSTNAME=0.0.0.0
            PORT=3000
            BACKEND_URL=http://127.0.0.1:3001
            JWT_TOKEN_KEY=auth-token
            EOF
            fi
            
            # é‡å¯æœåŠ¡ (ä½¿ç”¨ PM2)
            cd /home/apps/storehouse
            pm2 restart storehouse || pm2 start npm --name storehouse -- start
            pm2 save
            echo 'Service restarted'
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm /tmp/deploy.frontend.tar.gz
            
            # åªä¿ç•™æœ€è¿‘3ä¸ªå¤‡ä»½
            cd /home/apps && ls -t | grep storehouse.backup | tail -n +4 | xargs -r rm -rf
            echo 'Cleanup completed'
      # å¥åº·æ£€æŸ¥
      - name: Health check
        run: |
          sleep 10
          curl --fail http://${{ secrets.SERVER_HOST }}/api || exit 1
